 # 悬浮球功能模块代码

## 1. 悬浮球核心组件

### 1.1 floatingBall.tsx (核心实现)
```typescript
import { changeEvent } from '@/utils/handleDom';
import { makeStringProp } from '@/utils/props';
import { randomStr } from '@/utils/random';
import { isMobile } from '@/utils/tools';
import { defineComponent, ExtractPropTypes, onMounted, reactive, ref } from 'vue';
import type { PropType } from 'vue';
import { StyleType } from '@/utils/native-props';

const classPrefix = `legendTD-floating-ball`;

type StyleItem = 
| '--initial-position-left'
| '--initial-position-right'
| '--initial-position-top'
| '--initial-position-bottom'
| '--z-index'

export type FloatingBallEmit = {
  /** 贴边时触发 isLeft: true 代表是左或上方向上贴边 */
  onMagnetic?: (isLeft: boolean) => void
  /** 位置偏移时触发 */
  onOffsetChange?: (offset: {x: number, y: number}) => void
}

export const floatingBallProps = {
  /** 可以进行拖动的方向，'xy' 表示自由移动 默认值xy */
  axis: makeStringProp<'x' | 'y' | 'xy'>('xy'),
  /** 自动磁吸到边界 */
  magnetic: String as PropType<'x' | 'y'>,
  style: Object as PropType<StyleType<StyleItem>>
}

export type FloatingBallProps = ExtractPropTypes<typeof floatingBallProps>

const FloatingBall = defineComponent({
  props: floatingBallProps,
  emits: ['onMagnetic', 'onOffsetChange'],
  setup(props, ctx) {
    const {emit, slots} = ctx
    const idRef = ref(randomStr(classPrefix))
    /** 悬浮球的宽，高，上下左右距离 */
    const ball = reactive({w: 0, h: 0, r: 0, l: 0, t: 0, b: 0})
    const touchRef = reactive({
      startX: 0,
      startY: 0,
    })
    const info = reactive({
      x: 0,
      y: 0,
    })
    const buttonRef = ref<HTMLDivElement | null>(null)
    /** 动画时间 */
    const duration = ref(0.1);
  
    const onTouchStart = (e: MouseEvent | TouchEvent) => {
      e.stopPropagation()
      const newE = changeEvent(e)
      touchRef.startX = newE.clientX - info.x
      touchRef.startY = newE.clientY - info.y
      if(!isMobile()) {
        document.addEventListener('mousemove', onTouchMove, true)
        document.addEventListener('mouseup', onTouchEnd, true)
      }
      duration.value = 0.1
    }
    const onTouchMove = (e: MouseEvent | TouchEvent) => {
      e.stopPropagation()
      const newE = changeEvent(e)
      const x = props.axis === 'y' ? 0 : newE.clientX - touchRef.startX
      const y = props.axis === 'x' ? 0 : newE.clientY - touchRef.startY
      info.x = x
      info.y = y
      emit('onOffsetChange', {x, y})
    }
    const onTouchEnd = (e: MouseEvent | TouchEvent) => {
      e.stopPropagation()
      if(!isMobile()) {
        document.removeEventListener('mousemove', onTouchMove, true)
        document.removeEventListener('mouseup', onTouchEnd, true)
      }
      const newE = changeEvent(e)
      let x = props.axis === 'y' ? 0 : newE.clientX - touchRef.startX
      let y = props.axis === 'x' ? 0 : newE.clientY - touchRef.startY
      const {w, h, l, r, t, b} = ball
      if (props.magnetic === 'x') {
        const l_r = l < r ? l : r
        const _v = l < r ? -1 : 1
        const middleX = window.innerWidth / 2 - l_r - w / 2 // 中间分隔线的值
        const distance = -1 * _v * (window.innerWidth - w - l_r * 2) // 另一边的位置
        x = (Math.abs(x) > middleX) ? (x * _v < 0 ? distance : 0) : 0
        emit('onMagnetic', x === 0 ? l < r : l > r)
      } else if (props.magnetic === 'y') {
        const l_r = t < b ? t : b
        const _v = t < b ? -1 : 1
        const middleX = window.innerHeight / 2 - l_r - h / 2 // 中间分隔线的值
        const distance = -1 * _v * (window.innerHeight - h - l_r * 2) // 另一边的位置
        y = (Math.abs(y) > middleX) ? (y * _v < 0 ? distance : 0) : 0
        emit('onMagnetic', y === 0 ? t < b : t > b)
      }
      duration.value = 0.3
      info.x = x
      info.y = y
    }
  
    onMounted(() => {
      const init = () => {
        const ballDom = document.querySelector(`.${idRef.value} .${classPrefix}-button`)
        if(!ballDom) return
        const ballInfo = ballDom.getBoundingClientRect()
        ball.w = ballInfo.width
        ball.h = ballInfo.height
        ball.l = ballInfo.left
        ball.r = window.innerWidth - ballInfo.right
        ball.t = ballInfo.top
        ball.b = window.innerHeight - ballInfo.bottom
      }
      setTimeout(() => {
        init()
      }, 10);
    })
  
    const handleEvent = () => {
      if(!isMobile()) {
        return {
          onMousedown: onTouchStart,
          onMouseup: onTouchEnd,
        }
      } else {
        return {
          onTouchstart: onTouchStart,
          onTouchmove: onTouchMove,
          onTouchend: onTouchEnd,
          onTouchcancel: onTouchEnd,
        }
      }
    }
  
    return () => (
      <div class={`${classPrefix} ${idRef.value}`} {...props}>
        <div
          ref={buttonRef}
          class={`${classPrefix}-button`}
          style={{ 
            transitionDuration: duration.value + 's',
            transform: `translate(${info.x}px, ${info.y}px)`
           }}
          {...handleEvent()}
        >
          {slots?.default && slots.default()}
        </div>
      </div>
    )

  }
})

export default FloatingBall;
```

### 1.2 floatingBall.less (样式定义)
```less
@class-prefix: ~'legendTD-floating-ball';

.@{class-prefix} {
  &-button {
    position: fixed;
    top: var(--initial-position-top);
    right: var(--initial-position-right);
    bottom: var(--initial-position-bottom);
    left: var(--initial-position-left);
    z-index: var(--z-index);
    transition: transform ease-out 0.1s;
    user-select: none;
    touch-action: none;
  }
}
```

### 1.3 index.tsx (组件导出)
```typescript
import './floatingBall.less'
import FloatingBall from './floatingBall'
export type { FloatingBallProps } from './floatingBall'

export default FloatingBall
```

## 2. 依赖的工具函数

### 2.1 handleDom.ts (事件处理)
```typescript
export const changeEvent = (event: MouseEvent | TouchEvent) => {
  // changedTouches 是 touchEnd 的值
  return (
    (event as TouchEvent)?.touches?.[0] ??
    (event as TouchEvent)?.changedTouches?.[0] ??
    (event as MouseEvent)
  );
};
```

### 2.2 props.ts (属性定义)
```typescript
export const makeStringProp = <T>(defaultVal: T) => ({
  type: String as unknown as PropType<T>,
  default: defaultVal,
});
```

### 2.3 random.ts (随机字符串生成)
```typescript
export const randomStr = (v?: string) => `${v ? v + '-' : ''}${Math.ceil(Math.random() * 10e5).toString(36)}-${Date.now().toString(36)}`;
```

### 2.4 tools.ts (设备检测)
```typescript
export function isMobile() {
  return navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)
}
```

### 2.5 native-props.ts (样式类型)
```typescript
export type StyleType<S extends string = never> = CSSProperties & Partial<Record<S, string>>
```

## 3. 使用示例

### 3.1 userBall.vue (游戏中的悬浮球应用)
```vue
<template>
  <FloatingBall
    magnetic="x"
    :style="floatingBallStyle"
    @on-offset-change="status = 0"
    @on-magnetic="onMagnetic"
  >
    <div class="ball-wrap">
      <!-- 悬浮球内容 -->
    </div>
  </FloatingBall>
</template>

<script setup lang='ts'>
import FloatingBall from '@/components/floatingBall';
// ... 其他代码
</script>
```

## 4. 功能特点

1. **拖拽功能**：支持自由拖拽和指定方向拖拽(x/y/xy)
2. **磁吸边界**：自动吸附到屏幕左右或上下边界
3. **响应式设计**：适配移动端和桌面端
4. **事件回调**：提供贴边和位置变化的事件监听
5. **可定制样式**：通过CSS变量自定义初始位置和层级
6. **触摸支持**：同时支持鼠标和触摸操作

## 5. 技术栈

- Vue 3 Composition API
- TypeScript
- Less
- 原生DOM操作和事件处理
